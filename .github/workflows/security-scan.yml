name: Security Scanning

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    # Weekly security scan every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

# Cancel in-progress runs for the same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  security-tests:
    name: Security Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run crypto tests
        run: npx vitest run --reporter=verbose src/crypto/**/*.test.ts

      - name: Run security header tests
        run: npx vitest run --reporter=verbose src/__tests__/config/securityHeaders.test.ts

      - name: Run crypto utility tests
        run: npx vitest run --reporter=verbose src/__tests__/utils/crypto/**/*.test.ts

      - name: Run secure storage tests
        run: npx vitest run --reporter=verbose src/utils/secureStorage.test.ts

      - name: Run rate limiter tests
        run: npx vitest run --reporter=verbose src/__tests__/utils/rateLimiter.test.ts

      - name: Run key rotation tests
        run: npx vitest run --reporter=verbose src/services/multiUser/keyRotation.enhanced.service.test.ts

      - name: Security test summary
        if: always()
        run: |
          echo "## Security Test Results" >> $GITHUB_STEP_SUMMARY
          echo "All critical security tests completed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage:" >> $GITHUB_STEP_SUMMARY
          echo "- Cryptographic operations (encryption, key derivation)" >> $GITHUB_STEP_SUMMARY
          echo "- Security headers configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Constant-time comparison utilities" >> $GITHUB_STEP_SUMMARY
          echo "- Secure storage mechanisms" >> $GITHUB_STEP_SUMMARY
          echo "- Rate limiting protection" >> $GITHUB_STEP_SUMMARY
          echo "- Key rotation for multi-user access" >> $GITHUB_STEP_SUMMARY

  dependency-audit:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit (Report only)
        id: audit_report
        run: |
          npm audit --json > audit-report.json || true
          npm audit >> audit-output.txt || true
        continue-on-error: true

      - name: Parse npm audit results
        id: parse_audit
        run: |
          CRITICAL=$(npm audit --json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(npm audit --json | jq '.metadata.vulnerabilities.high // 0')
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "## Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "- Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- High: $HIGH" >> $GITHUB_STEP_SUMMARY

      - name: Fail on critical vulnerabilities
        if: steps.parse_audit.outputs.critical > 0
        run: |
          echo "CRITICAL: Found ${{ steps.parse_audit.outputs.critical }} critical vulnerabilities"
          echo "Critical vulnerabilities must be addressed before merging."
          npm audit
          exit 1

      - name: Report high vulnerabilities
        if: steps.parse_audit.outputs.high > 0 && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const auditOutput = fs.readFileSync('audit-output.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Security Alert: High Severity Vulnerabilities Detected\n\nThis PR introduces or is based on code with **${{ steps.parse_audit.outputs.high }} high-severity vulnerabilities**.\n\nPlease review and address these vulnerabilities. High-severity issues require justification in the PR description before merging.\n\n\`\`\`\n${auditOutput}\n\`\`\`\n\n**Action Required:**\n- [ ] Run \`npm audit fix\` locally and push changes\n- [ ] Or add justification in PR description if vulnerabilities are unavoidable\n- [ ] Or create a follow-up issue to address in next sprint`
            })

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-report
          path: |
            audit-report.json
            audit-output.txt
          retention-days: 30

  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog secret detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --json

      - name: Run GitHub native secret scanning
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('GitHub native secret scanning is enabled for this repository.');
            console.log('Secrets detected will be reported as security alerts.');

      - name: Check for common secret patterns
        run: |
          set +e

          echo "Scanning for common secret patterns..."

          # Check for AWS keys
          FOUND=0
          if grep -r "AKIA[0-9A-Z]\{16\}" . --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json" 2>/dev/null; then
            echo "WARNING: Potential AWS access key detected"
            FOUND=1
          fi

          # Check for GitHub tokens
          if grep -r "ghp_[a-zA-Z0-9]\{36\}" . --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json" 2>/dev/null; then
            echo "WARNING: Potential GitHub token detected"
            FOUND=1
          fi

          # Check for generic API keys in code
          if grep -r "api[_-]?key.*=" . --include="*.ts" --include="*.tsx" --include="*.js" 2>/dev/null | grep -v node_modules | grep -v ".git" | head -5; then
            echo "INFO: Found potential API key assignments (manual review required)"
          fi

          if [ $FOUND -eq 1 ]; then
            echo "CRITICAL: Secrets detected in code!"
            exit 1
          fi

          exit 0

  static-analysis:
    name: Static Application Security Testing (SAST)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with security rules
        run: npm run lint
        continue-on-error: true

      - name: Run TypeScript type checking
        run: npm run type-check
        continue-on-error: true

      - name: Check for common security issues
        id: semgrep
        run: |
          echo "Running security pattern analysis..."

          # Check for hardcoded credentials
          echo "Checking for hardcoded credentials..."
          if grep -r "password\s*=\s*['\"]" src --include="*.ts" --include="*.tsx" | grep -v ".test." | grep -v ".spec."; then
            echo "WARNING: Potential hardcoded password found"
          fi

          # Check for unsafe crypto usage
          echo "Checking for unsafe crypto practices..."
          if grep -r "crypto\." src --include="*.ts" --include="*.tsx" | grep -E "(Math\.random|randomBytes\(1\)|randomInt\(1\))"; then
            echo "WARNING: Potentially unsafe randomness detected"
          fi

          # Check for SQL injection patterns
          echo "Checking for SQL injection patterns..."
          if grep -r "SELECT.*\$\|template.*SELECT" src --include="*.ts" --include="*.tsx" | grep -v ".test."; then
            echo "INFO: Found SQL patterns (review for parameterization)"
          fi

          # Check for eval usage
          echo "Checking for eval usage..."
          if grep -r "\beval\s*(" src --include="*.ts" --include="*.tsx" | grep -v ".test."; then
            echo "CRITICAL: eval() detected - security risk!"
            exit 1
          fi

          echo "Static analysis complete"

      - name: Verify encryption implementation
        run: |
          echo "Verifying critical security implementations..."

          if grep -r "AES-256\|Argon2id" src --include="*.ts" --include="*.tsx" > /dev/null; then
            echo "‚úì Encryption standards verified (AES-256, Argon2id)"
          else
            echo "‚ö† WARNING: Core encryption implementations not clearly documented"
          fi

          if grep -r "zero.knowledge\|zero-knowledge" src --include="*.ts" --include="*.tsx" docs --include="*.md" > /dev/null; then
            echo "‚úì Zero-knowledge architecture documented"
          else
            echo "‚ö† WARNING: Zero-knowledge architecture not documented in code"
          fi

  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate SBOM (Software Bill of Materials)
        run: |
          npm ls --json > sbom.json || true
          echo "SBOM generated"

      - name: Check npm outdated packages
        id: outdated
        run: |
          npm outdated --json > outdated.json || true
          OUTDATED_COUNT=$(npm outdated --json | jq 'keys | length' || echo "0")
          echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
          echo "Found $OUTDATED_COUNT outdated packages"

      - name: Report outdated dependencies
        if: steps.outdated.outputs.outdated_count > 0
        run: |
          echo "Outdated packages detected. Consider updating dependencies."
          echo "Run 'npm outdated' for details."

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom-report
          path: sbom.json
          retention-days: 30

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, security-tests, dependency-audit, secret-detection, static-analysis, dependency-check]
    if: always()
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Generate security report
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results:" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL Analysis: ${{ needs.codeql-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Tests: ${{ needs.security-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Audit: ${{ needs.dependency-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Detection: ${{ needs.secret-detection.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Static Analysis: ${{ needs.static-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Check: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Available:" >> $GITHUB_STEP_SUMMARY
          echo "- npm audit report" >> $GITHUB_STEP_SUMMARY
          echo "- Software Bill of Materials (SBOM)" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL security report (in Security tab)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All critical security checks must pass before merge.**" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const codeql = '${{ needs.codeql-analysis.result }}';
            const secTests = '${{ needs.security-tests.result }}';
            const depAudit = '${{ needs.dependency-audit.result }}';
            const secretScan = '${{ needs.secret-detection.result }}';
            const staticAnalysis = '${{ needs.static-analysis.result }}';
            const depCheck = '${{ needs.dependency-check.result }}';

            const statusEmoji = {
              'success': '‚úÖ',
              'failure': '‚ùå',
              'skipped': '‚è≠Ô∏è',
              'cancelled': 'üõë'
            };

            const body = `## Security Scanning Results

| Check | Status |
|-------|--------|
| CodeQL Analysis | ${statusEmoji[codeql]} ${codeql} |
| Security Tests | ${statusEmoji[secTests]} ${secTests} |
| Dependency Audit | ${statusEmoji[depAudit]} ${depAudit} |
| Secret Detection | ${statusEmoji[secretScan]} ${secretScan} |
| Static Analysis | ${statusEmoji[staticAnalysis]} ${staticAnalysis} |
| Dependency Check | ${statusEmoji[depCheck]} ${depCheck} |

**Security artifacts are available in the Actions tab.**

For detailed reports, see:
- npm audit report
- Software Bill of Materials (SBOM)
- CodeQL analysis (Security tab)`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if critical security checks failed
        if: |
          needs.codeql-analysis.result == 'failure' ||
          needs.security-tests.result == 'failure' ||
          needs.dependency-audit.result == 'failure' ||
          needs.secret-detection.result == 'failure'
        run: |
          echo "Critical security checks failed!"
          exit 1
