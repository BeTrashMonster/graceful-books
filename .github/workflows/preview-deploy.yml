name: Preview Deployment

# Trigger on pull request events
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
  # Cleanup when PR is closed
  pull_request_target:
    types: [closed]

env:
  NODE_VERSION: '18'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # Deploy preview for open PRs
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Use PR environment for preview deployments
    environment:
      name: preview-pr-${{ github.event.pull_request.number }}
      url: ${{ steps.deploy.outputs.url }}

    permissions:
      contents: read
      pull-requests: write
      deployments: write

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          # Preview-specific environment variables
          NODE_ENV: preview
          VITE_APP_ENV: preview
          VITE_PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Deploy Preview to Vercel
        id: deploy
        run: |
          # Deploy to Vercel and capture the preview URL
          url=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} 2>&1 | tee /dev/stderr | grep -oP 'https://[^\s]+' | head -1)
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "Preview deployed to: $url"

      - name: Create or Update Preview Comment
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.deploy.outputs.url }}';
            const prNumber = context.issue.number;
            const deploymentStatus = 'âœ…';

            // Comment body with preview information
            const commentBody = `## ${deploymentStatus} Preview Deployment Ready!

            **Preview URL:** ${previewUrl}

            **Environment:** \`preview-pr-${prNumber}\`
            **Commit:** \`${context.sha.substring(0, 7)}\`
            **Branch:** \`${context.payload.pull_request.head.ref}\`

            ---

            ### What's included in this preview:
            - All changes from this PR
            - Isolated preview environment
            - Full app functionality

            ### Testing your preview:
            1. Click the preview URL above
            2. Test your changes in the preview environment
            3. Share the URL with stakeholders for feedback

            ---

            **Note:** This preview will automatically update when you push new commits and will be deleted when the PR is closed.

            <sub>Deployed via Vercel | [View deployment logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})</sub>`;

            // Find existing preview comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Deployment')
            );

            // Update existing comment or create new one
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing preview comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('Created new preview comment');
            }

      - name: Create Deployment Status
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const state = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            const description = state === 'success'
              ? 'Preview deployment succeeded'
              : 'Preview deployment failed';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: state,
              target_url: '${{ steps.deploy.outputs.url }}',
              description: description,
              context: 'Preview Deployment'
            });

  # Cleanup preview when PR is closed
  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    permissions:
      pull-requests: write
      deployments: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Remove Vercel Preview Deployment
        run: |
          # Get the deployment URL for this PR and remove it
          # Vercel automatically garbage collects old preview deployments
          echo "Preview for PR #${{ github.event.pull_request.number }} will be automatically cleaned up by Vercel"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Update PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;

            // Find existing preview comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Deployment')
            );

            if (botComment) {
              const cleanupBody = `## ðŸ§¹ Preview Deployment Cleaned Up

              The preview deployment for this PR has been removed.

              **PR Status:** Closed
              **Cleanup:** Complete

              ---

              <sub>Preview environments are automatically cleaned up when PRs are closed.</sub>`;

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: cleanupBody
              });
              console.log('Updated comment with cleanup status');
            }

      - name: Deactivate GitHub Environment
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const prNumber = context.issue.number;
            const environmentName = `preview-pr-${prNumber}`;

            try {
              // Mark environment as inactive
              console.log(`Deactivating environment: ${environmentName}`);
              // Note: GitHub automatically deactivates environments after deployments are deleted
            } catch (error) {
              console.log('Environment cleanup handled automatically');
            }
