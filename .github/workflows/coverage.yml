name: Code Coverage

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for accurate diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage -- --run
        env:
          CI: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          name: graceful-books-coverage
          fail_ci_if_error: true
          verbose: true

      - name: Archive coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Check coverage thresholds
        run: |
          echo "Checking coverage thresholds..."
          npm run test:coverage -- --run --reporter=json --outputFile=coverage-summary.json

          # Parse coverage summary
          LINES=$(cat coverage-summary.json | grep -o '"lines":{[^}]*}' | grep -o '"pct":[0-9.]*' | cut -d: -f2)
          FUNCTIONS=$(cat coverage-summary.json | grep -o '"functions":{[^}]*}' | grep -o '"pct":[0-9.]*' | cut -d: -f2)
          BRANCHES=$(cat coverage-summary.json | grep -o '"branches":{[^}]*}' | grep -o '"pct":[0-9.]*' | cut -d: -f2)
          STATEMENTS=$(cat coverage-summary.json | grep -o '"statements":{[^}]*}' | grep -o '"pct":[0-9.]*' | cut -d: -f2)

          echo "Coverage Results:"
          echo "Lines: ${LINES}%"
          echo "Functions: ${FUNCTIONS}%"
          echo "Branches: ${BRANCHES}%"
          echo "Statements: ${STATEMENTS}%"

          # Check if all metrics meet 80% threshold
          THRESHOLD=80
          PASSED=true

          if (( $(echo "$LINES < $THRESHOLD" | bc -l) )); then
            echo "‚ùå Line coverage ${LINES}% is below threshold ${THRESHOLD}%"
            PASSED=false
          fi

          if (( $(echo "$FUNCTIONS < $THRESHOLD" | bc -l) )); then
            echo "‚ùå Function coverage ${FUNCTIONS}% is below threshold ${THRESHOLD}%"
            PASSED=false
          fi

          if (( $(echo "$BRANCHES < $THRESHOLD" | bc -l) )); then
            echo "‚ùå Branch coverage ${BRANCHES}% is below threshold ${THRESHOLD}%"
            PASSED=false
          fi

          if (( $(echo "$STATEMENTS < $THRESHOLD" | bc -l) )); then
            echo "‚ùå Statement coverage ${STATEMENTS}% is below threshold ${THRESHOLD}%"
            PASSED=false
          fi

          if [ "$PASSED" = false ]; then
            echo "Coverage thresholds not met!"
            exit 1
          fi

          echo "‚úÖ All coverage thresholds met!"

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read coverage summary
            const coverageSummary = JSON.parse(fs.readFileSync('coverage-summary.json', 'utf8'));
            const total = coverageSummary.total;

            // Format coverage data
            const lines = total.lines.pct.toFixed(2);
            const functions = total.functions.pct.toFixed(2);
            const branches = total.branches.pct.toFixed(2);
            const statements = total.statements.pct.toFixed(2);

            // Create badge colors
            const getBadgeColor = (pct) => {
              if (pct >= 80) return 'brightgreen';
              if (pct >= 60) return 'yellow';
              if (pct >= 40) return 'orange';
              return 'red';
            };

            const linesColor = getBadgeColor(lines);
            const functionsColor = getBadgeColor(functions);
            const branchesColor = getBadgeColor(branches);
            const statementsColor = getBadgeColor(statements);

            // Create comment body
            const comment = `## üìä Code Coverage Report

            | Metric | Coverage | Status |
            |--------|----------|--------|
            | **Lines** | ![${lines}%](https://img.shields.io/badge/coverage-${lines}%25-${linesColor}) | ${lines >= 80 ? '‚úÖ' : '‚ö†Ô∏è'} |
            | **Functions** | ![${functions}%](https://img.shields.io/badge/coverage-${functions}%25-${functionsColor}) | ${functions >= 80 ? '‚úÖ' : '‚ö†Ô∏è'} |
            | **Branches** | ![${branches}%](https://img.shields.io/badge/coverage-${branches}%25-${branchesColor}) | ${branches >= 80 ? '‚úÖ' : '‚ö†Ô∏è'} |
            | **Statements** | ![${statements}%](https://img.shields.io/badge/coverage-${statements}%25-${statementsColor}) | ${statements >= 80 ? '‚úÖ' : '‚ö†Ô∏è'} |

            **Threshold:** 80% for all metrics

            ${lines >= 80 && functions >= 80 && branches >= 80 && statements >= 80
              ? '‚úÖ All coverage thresholds met!'
              : '‚ö†Ô∏è Some coverage thresholds not met. Please add tests.'}

            <details>
            <summary>üìà Detailed Coverage Report</summary>

            View the full coverage report in the [Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).

            </details>
            `;

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Update coverage badge
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "Coverage badge will be updated via Codecov"
          echo "Badge URL: https://codecov.io/gh/${{ github.repository }}/branch/main/graph/badge.svg"

      - name: Generate coverage summary
        run: |
          echo "## üìä Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage report generated and uploaded to Codecov." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed report: [Codecov Dashboard](https://codecov.io/gh/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
